# Distributed deployment mode with microservices components
# This uses the full distributed microservices architecture with individual components:
# ingester, querier, distributor, compactor, query-frontend, etc.
deploymentMode: Distributed

# Explicitly disable Loki Canary
lokiCanary:
  enabled: false

loki:
  auth_enabled: false

  storage:
    type: %{ if cloud_provider == "gke" }gcs%{ else }s3%{ endif }
    bucketNames:
      chunks: ${loki_chunks_bucket}
      ruler: ${loki_ruler_bucket}
      admin: ${loki_chunks_bucket}
    %{ if cloud_provider == "gke" }
    gcs:
      chunkBufferSize: 0
      requestTimeout: "0s"
      enableHttp2: true
    %{ else }
    s3:
      region: ${aws_region}
      s3ForcePathStyle: false
    %{ endif }
  
  commonConfig:
    replication_factor: 1
    path_prefix: /var/loki
  
  schemaConfig:
    configs:
      - from: "${loki_schema_from_date}"
        store: tsdb
        object_store: %{ if cloud_provider == "gke" }gcs%{ else }s3%{ endif }
        schema: v13
        index:
          prefix: loki_index_
          period: 24h
  
  limits_config:
    retention_period: 720h
    reject_old_samples: true
    reject_old_samples_max_age: 168h
    ingestion_rate_mb: 100
    ingestion_burst_size_mb: 200
    per_stream_rate_limit: 50MB
    per_stream_rate_limit_burst: 100MB
    max_entries_limit_per_query: 100000
    max_streams_per_user: 0
    allow_structured_metadata: true
    volume_enabled: true
  
  pattern_ingester:
    enabled: true
  
  ruler:
    enable_api: true
    storage:
      type: %{ if cloud_provider == "gke" }gcs%{ else }s3%{ endif }
      %{ if cloud_provider == "gke" }
      gcs:
        bucket_name: ${loki_ruler_bucket}
      %{ else }
      s3:
        bucket_name: ${loki_ruler_bucket}
        region: ${aws_region}
      %{ endif }
  
  ingester:
    chunk_encoding: snappy
  
  compactor:
    working_directory: /var/loki/compactor 
    compaction_interval: 10m
    retention_enabled: true
    retention_delete_delay: 2h
    retention_delete_worker_count: 150
    delete_request_store: %{ if cloud_provider == "gke" }gcs%{ else }s3%{ endif }
  
  analytics:
    reporting_enabled: false

# Global resource limits for Loki components (optimized for resource constraints)
resources:
  requests:
    cpu: 100m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 1.5Gi

serviceAccount:
  create: false
  name: ${k8s_service_account_name}
  annotations:
    %{ if cloud_provider == "gke" }iam.gke.io/gcp-service-account: ${gcp_service_account_email}%{ endif }
    %{ if cloud_provider == "eks" }eks.amazonaws.com/role-arn: ${aws_role_arn}%{ endif }

singleBinary:
  replicas: 0
  persistence:
    enabled: true             
    size: 5Gi                
    storageClass: standard-rwo
  affinity: {}
  
gateway:
  enabled: true
  replicas: 2
  maxUnavailable: 1
  affinity:
    podAntiAffinity: null
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/os
            operator: In
            values:
            - linux
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1.5Gi
  ingress:
    enabled: false
    ingressClassName: ${ingress_class_name}
    annotations:
      cert-manager.io/issuer: ${cert_issuer_name}
      external-dns.alpha.kubernetes.io/hostname: loki.${monitoring_domain} # Replace with your Loki domain name (e.g., loki.yourdomain.com)

backend:
  replicas: 0
read:
  replicas: 0
write:
  replicas: 0
ingester:
  replicas: 2
  maxUnavailable: 1
  zoneAwareReplication:
    enabled: false

  affinity:
    podAntiAffinity: null
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/os
            operator: In
            values:
            - linux
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1.5Gi
querier:
  replicas: 2
  maxUnavailable: 1
  affinity:
    podAntiAffinity: null
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/os
            operator: In
            values:
            - linux
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1.5Gi
queryFrontend:
  replicas: 2
  maxUnavailable: 1
  affinity:
    podAntiAffinity: null
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/os
            operator: In
            values:
            - linux
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1.5Gi
queryScheduler:
  replicas: 2
  maxUnavailable: 1
  affinity:
    podAntiAffinity: null
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/os
            operator: In
            values:
            - linux
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1.5Gi
distributor:
  replicas: 2
  maxUnavailable: 1
  affinity:
    podAntiAffinity: null
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/os
            operator: In
            values:
            - linux
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1.5Gi
compactor:
  replicas: 1
  affinity:
    podAntiAffinity: null
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/os
            operator: In
            values:
            - linux
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1.5Gi
indexGateway:
  replicas: 2
  maxUnavailable: 1
  affinity:
    podAntiAffinity: null
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: kubernetes.io/os
            operator: In
            values:
            - linux
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1.5Gi
bloomCompactor:
  replicas: 0
bloomGateway:
  replicas: 0

chunksCache:
  enabled: true
resultsCache:
  enabled: true

minio:
  enabled: false

test:
  enabled: false

monitoring:
  selfMonitoring:
    enabled: false
    grafanaAgent:
      installOperator: false
  lokiCanary:
    enabled: false
